{% extends "base.html" %}

{% block content %}
<body>
    <div class="max-w-7xl mx-auto py-6 px-4">
        <h1 class="text-2xl font-bold mb-4">Assigned Parts to Buses</h1>
        
        <div class="flex justify-between mb-4">
            <input type="text" id="search" placeholder="Search..." class="border rounded px-2 py-1" oninput="filterTable()">
            <div class="flex space-x-2">
                <select id="filterBus" onchange="filterTable()">
                    <option value="">Filter by Bus ID</option>
                     <!-- Populate options dynamically -->
                </select>
                <select id="filterAssignedBy" onchange="filterTable()">
                    <option value="">Filter by Assigned By</option>
                    <!-- Populate options dynamically -->
                </select>
                
                <select id="sortOptions" onchange="sortTable()">
                    <option value="date_desc">Sort by Date Assigned (Latest)</option>
                    <option value="date_asc">Sort by Date Assigned (Oldest)</option>
                    <option value="qty_desc">Sort by Quantity Assigned (High to Low)</option>
                    <option value="qty_asc">Sort by Quantity Assigned (Low to High)</option>
                </select>
            </div>
        </div>

        <table class="min-w-full bg-white border border-gray-300">
            <thead>
                <tr class="bg-gray-200">
                    <th class="py-2 px-4 border">Bus ID</th>
                    <th class="py-2 px-4 border">Bus Number</th>
                    <th class="py-2 px-4 border">Product ID</th>
                    <th class="py-2 px-4 border">Product Name</th>
                    <th class="py-2 px-4 border">Quantity Assigned</th>
                    <th class="py-2 px-4 border">Assigned By</th>
                    <th class="py-2 px-4 border">Date Assigned</th>
                </tr>
            </thead>
            <tbody id="assignments-table-body">
                {% for assignment in assignments %}
                <tr class="hover:bg-gray-100">
                    <td class="py-2 px-4 border">{{ assignment.bus_id }}</td>
                    <td class="py-2 px-4 border">{{ assignment.bus_number }}</td>
                    <td class="py-2 px-4 border">{{ assignment.product_id }}</td>
                    <td class="py-2 px-4 border">{{ assignment.product_name }}</td>
                    <td class="py-2 px-4 border">{{ assignment.quantity }}</td>
                    <td class="py-2 px-4 border">{{ assignment.assigned_by }}</td>
                    <td class="py-2 px-4 border">{{ assignment.date_assigned }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        function filterTable() {
            const searchValue = document.getElementById('search').value.toLowerCase();
            const filterBus = document.getElementById('filterBus').value;
            const filterAssignedBy = document.getElementById('filterAssignedBy').value;
            const rows = document.querySelectorAll('#assignments-table-body tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const busId = cells[0].textContent.toLowerCase();
                const busName = cells[1].textContent.toLowerCase();
                const assignedBy = cells[5].textContent.toLowerCase();
                const matchesSearch = busName.includes(searchValue) || assignedBy.includes(searchValue);
                const matchesBusFilter = filterBus ? busId === filterBus : true;
                const matchesAssignedByFilter = filterAssignedBy ? assignedBy === filterAssignedBy : true;

                if (matchesSearch && matchesBusFilter && matchesAssignedByFilter) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function sortTable() {
            const sortOption = document.getElementById('sortOptions').value;
            const rows = Array.from(document.querySelectorAll('#assignments-table-body tr'));
            const sortedRows = rows.sort((a, b) => {
                const qtyA = parseInt(a.cells[4].textContent);
                const qtyB = parseInt(b.cells[4].textContent);
                const dateA = new Date(a.cells[6].textContent);
                const dateB = new Date(b.cells[6].textContent);

                if (sortOption === 'date_desc') return dateB - dateA;
                if (sortOption === 'date_asc') return dateA - dateB;
                if (sortOption === 'qty_desc') return qtyB - qtyA;
                if (sortOption === 'qty_asc') return qtyA - qtyB;
            });

            const tbody = document.getElementById('assignments-table-body');
            tbody.innerHTML = '';
            sortedRows.forEach(row => tbody.appendChild(row));
        }
    </script>
{% endblock %}
